<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{user/layout-user.html}">
<head>
<meta charset="UTF-8">
<title>Title</title>
</head>
<body>

	<div layout:fragment="content">
		<div id="loading-overlay">
			<div class="loading-spinner"></div>
		</div>
		<!-- Modal -->
		<div class="modal fade" id="exampleModalCenter" tabindex="-1"
			role="dialog" aria-labelledby="exampleModalCenterTitle"
			aria-hidden="true" style="z-index: 3000">
			<div class="modal-dialog modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLongTitle">Chọn mã
							giảm giá</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body" style="overflow-y: auto; max-height: 400px">
						<th:block th:each="voucher : ${discountCodes}">
							<div th:data-voucher-id="${voucher.id}"
								class="d-flex border border-primary rounded align-items-center cursor-pointer voucher-item mb-2">
								<div
									class="col-sm-3 d-flex justify-content-center align-items-center "
									style="background-color: rgb(219, 234, 254); height: 80px">
									<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
										viewBox="0 0 24 24">
										<path fill="currentColor"
											d="M12.79 21L3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"></path>
										<path fill="currentColor"
											d="M11.38 17.41c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.63.58A2.04 2.04 0 0 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM7.25 3a1.25 1.25 0 1 1 0 2.5a1.25 1.25 0 0 1 0-2.5z"></path></svg>
								</div>
								<div class="col-sm-9">
									<div class="w-full">
										<p class="font-weight-bold amount-dis">
											Giảm <span th:if="${voucher.type == 2}"
												th:text="${#numbers.formatDecimal(voucher.discountAmount, 0, 'POINT', 0, 'COMMA') + ' VND'}"></span>
											<span th:if="${voucher.type == 1}"
												th:text="${voucher.percentage} + '%'"></span>
										</p>
										<div>
											<span class="mr-4 amount-mini"
												th:text="${'Cho đơn từ ' + #numbers.formatDecimal(voucher.minimumAmountInCart, 0, 'POINT', 0, 'COMMA') + ' VND'}">
											</span> <span class="amount-max" th:if="${voucher.type == 1}"
												th:text="'Giảm tối đa ' + ${#numbers.formatDecimal(voucher.maximumAmount, 0, 'POINT', 0, 'COMMA') + ' VND'}"></span>
										</div>

										<div class="d-flex align-items-center ">
											<span class="mr-2 text-sm text-gray-600"
												th:text="${'HSD: ' + #dates.format(voucher.endDate, 'dd/MM/yyyy')}">:
												[[]</span>
										</div>
									</div>
								</div>
							</div>
						</th:block>

					</div>
				</div>
			</div>
		</div>
		<!-- breadcrumb -->
		<div class="container">
			<div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
				<a href="/" class="stext-109 cl8 hov-cl1 trans-04"> Home <i
					class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
				</a> <span class="stext-109 cl4"> Shoping Cart </span>
			</div>
		</div>

		<!-- Shoping Cart -->
		<form class="bg0 p-t-75 p-b-85">
			<div class="container">
				<div class="">
					<div class=" m-b-50">
						<div class="">
							<!-- Khi carts == null hoặc rỗng -->
							<div th:if="${carts == null or #lists.size(carts) == 0}"
								class="d-flex flex-column align-items-center">
								<img src="https://i.imgur.com/dCdflKN.png" width="130"
									height="130" class="img-fluid mb-4 mr-3">
								<h3>
									<strong>Giỏ hàng hiện tại trống</strong>
								</h3>
								<a th:href="@{/getproduct}"
									class="btn btn-primary cart-btn-transform m-3" data-abc="true">Tiếp
									tục mua sắm</a>
							</div>

							<!-- Khi có sản phẩm trong giỏ hàng -->
							<div class="wrap-table-shopping-cart"
								th:if="${carts != null and #lists.size(carts) > 0}">
								<table class="table-shopping-cart">
									<tr class="table_head">
										<th class="column-1">Hình ảnh</th>
										<th class="column-2">Sản phẩm</th>
										<th class="column-3">Giá</th>
										<th class="column-4">Size</th>
										<th class="column-5">Lượng đường</th>
										<th class="column-6">Số lượng</th>
										<th class="column-7">Tổng</th>
									</tr>

									<tr class="table-row product-item" th:each="cart : ${carts}">
										<input type="hidden" th:value="${cart.id}" class="cartId">
										<input type="hidden"
											th:value="${cart.detail != null ? cart.detail.id : ''}"
											class="detailId">

										<!-- Hình ảnh -->
										<td class="column-1">
											<div class="how-itemcart1 ml-2">
												<img th:src="@{'/' + ${cart.product.imageUrl}}" alt="IMG">
											</div>
										</td>

										<!-- Tên sản phẩm -->
										<td class="column-2" th:text="${cart.product.name}"></td>

										<!-- Giá -->
										<td class="column-3"><span class="product-old-price"
											th:if="${cart.detail != null and cart.detail.discountedPrice != null}"
											th:text="${#numbers.formatDecimal(cart.detail.price, 0, 'POINT', 0, 'COMMA')}"
											style="text-decoration: line-through; font-size: 12px"></span>

											<span class="product-price"
											th:if="${cart.detail != null and cart.detail.discountedPrice != null}"
											th:text="${#numbers.formatDecimal(cart.detail.discountedPrice, 0, 'POINT', 0, 'COMMA')}"></span>

											<span class="product-price"
											th:if="${cart.detail != null and cart.detail.discountedPrice == null}"
											th:text="${#numbers.formatDecimal(cart.detail.price, 0, 'POINT', 0, 'COMMA')}"></span>

											<span class="product-price" th:if="${cart.detail == null}"
											th:text="${#numbers.formatDecimal(cart.product.price, 0, 'POINT', 0, 'COMMA')}"></span>
										</td>

										<!-- Size -->
										<td class="column-4"
											th:text="${cart.detail != null ? cart.detail.size.name : '-'}"></td>

										<!-- Màu sắc -->
										<td class="column-5"
											th:text="${cart.detail != null ? cart.detail.color.name : '-'}"></td>

										<!-- Số lượng -->
										<td class="column-6">
											<div class="wrap-num-product flex-w m-l-auto m-r-0">
												<div
													class="btn-num-product-down js-update-cart-down cl8 hov-btn3 trans-04 flex-c-m">
													<i class="fs-16 zmdi zmdi-minus"></i>
												</div>

												<input class="mtext-104 cl3 txt-center num-product"
													type="number" th:name="'num-product'+${cart.id}"
													th:value="${cart.quantity}">

												<div
													class="btn-num-product-up js-update-cart-up cl8 hov-btn3 trans-04 flex-c-m">
													<i class="fs-16 zmdi zmdi-plus"></i>
												</div>
											</div>
										</td>


										<!-- Cột tổng -->
										<td class="column-7 text-right align-middle"
											style="width: 100px; font-weight: 600;"><span
											class="total-money text-dark">0 VND</span></td>
										<!-- Cột topping -->
										<td class="column-toppings align-top" style="width: 220px;">
											<div
												class="topping-container border rounded p-2 mt-2 bg-light"
												th:attr="id=${'topping-selection-' + cart.detail.id}"
												style="max-height: 150px; overflow-y: auto; font-size: 13px;">
												<p class="text-muted text-center m-0 py-2">
													<i class="fas fa-spinner fa-spin"></i> Đang tải topping...
												</p>
											</div>
										</td>
									</tr>
								</table>
							</div>



							<!-- Chọn voucher -->
							<div th:if="${carts != null and #lists.size(carts) > 0}">
								<span
									class="d-inline-block p-t-18 p-b-15 p-l-2 btn-choose-voucher"
									data-toggle="modal" data-target="#exampleModalCenter"> <span
									class="font-weight-bold"> <i class="fa fa-tags"
										aria-hidden="true"></i> Chọn mã giảm giá
								</span>
								</span>
								<div id="selected-voucher" class="p-l-2" data-selected="">

								</div>
							</div>
						</div>
					</div>

				</div>

				<div class=" m-b-50">
					<div class="bor10 p-lr-40 p-t-30 p-b-40">
						<h4 class="mtext-109 cl2 p-b-30">Thông tin đơn hàng</h4>
						<div class="flex-w flex-t bor12 p-b-13">
							<div class="size-208">
								<span class="stext-110 cl2"> Tổng tiền: </span>
							</div>

							<div class="size-209">
								<span class="mtext-110 cl2" id="sub-total"> </span>
							</div>
						</div>

						<div class="flex-w flex-t bor12 p-t-15 p-b-30">
							<div class="size-208 w-full-ssm">
								<span class="stext-110 cl2"> Shipping: </span>
							</div>

							<div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
								<div class="p-t-15 addressArea">
									<span class="stext-112 cl8"> Chọn địa chỉ </span>
									<div class="address-list pt-15">
										<div
											th:if="${addressShippings != null and not #lists.isEmpty(addressShippings)}"
											class="pt-15">
											<div th:each="address : ${addressShippings}"
												class="shipping-choose">
												<div th:id="'shipping' + ${address.id}">
													<p th:text="${address.address}"></p>
												</div>
											</div>
										</div>
									</div>
									<button type="button" class="bg2 size-102" id="add-address">Thêm
										địa chỉ +</button>

									<div id="address-select-group" style="display: none">
										<div class="bor8 bg0 m-b-12">
											<input class="stext-111 cl8 plh3 size-111 p-lr-15"
												type="text" name="street" id="street"
												placeholder="Số nhà, đường, xóm">
										</div>
										<span class="stext-111 errorStreet"
											style="color: red; display: none">Vui lòng nhập số
											nhà, đường, xóm</span>
										<div>
											<button class="bg2 size-102 hov-btn3" type="button"
												id="save-address-btn">Lưu</button>
											<button class="bor8 size-102" type="button"
												id="cancel-add-address">Bỏ qua</button>
										</div>
									</div>

								</div>
							</div>
						</div>
						<!-- ===================== CHỌN CHI NHÁNH ===================== -->
						<div class="flex-w flex-t bor12 p-t-15 p-b-30">
							<div class="size-208 w-full-ssm">
								<span class="stext-110 cl2"> Chi nhánh: </span>
							</div>

							<div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
								<div class="p-t-15 branchArea">
									<span class="stext-112 cl8"> Chọn chi nhánh phục vụ </span>
									<div id="branchList" class="row g-3 pt-3">
										<div class="col-12 text-center py-3">
											<div class="spinner-border text-primary" role="status"></div>
											<p class="mt-2 mb-0 text-secondary">Đang tải danh sách
												chi nhánh...</p>
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- =========================================================== -->






						<div class="flex-w flex-t bor12 p-t-15 p-b-30">
							<div class="size-208 w-full-ssm">
								<span class="stext-110 cl2"> Voucher: </span>

							</div>
							<div class="size-209">
								<span class="mtext-110 cl2" id="voucher-pic"> 0 VND </span>
							</div>
						</div>
						<div class="flex-w flex-t p-t-27 p-b-33">
							<div class="size-208">
								<span class="mtext-101 cl2"> Thành tiền: </span>
							</div>

							<div class="size-209 p-t-1">
								<span class="mtext-110 cl2" id="all-total"> </span>
							</div>
						</div>
						<div class="flex-w flex-t p-t-27 p-b-33">
							<div class="size-208">
								<span class="mtext-101 cl2"> Phương thức thanh toán: </span>
							</div>

							<div class="size-209 p-t-1">
								<div class="form-group">
									<input type="radio" class="custom-radio" value="3"
										name="paymentMethod" id="payment-online" checked> <label
										for="payment-online">Chuyển khoản</label>
								</div>
								<div class="form-group">
									<input type="radio" class="custom-radio" value="1"
										name="paymentMethod" id="payment-offline"> <label
										for="payment-offline">Tiền mặt</label>
								</div>
							</div>
						</div>

						<label class="checkbox d-flex"> <input type="checkbox"
							class="mr-2" id="term"> Tôi đồng ý với <a
							style="color: blue" data-toggle="modal"
							data-target="#exampleModalCenter2">&nbsp; điều khoản &nbsp</a>
							của cửa hàng
						</label>
						<button type="button" id="submitBtn"
							class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer"
							disabled>Đặt hàng</button>
					</div>
				</div>
			</div>
		</form>
		<div class="modal fade" style="z-index: 3000" id="exampleModalCenter2"
			tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
			aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-lg"
				role="document">
				<div class="modal-content" style="max-width24: 100%">
					<div class="modal-header">
						<h5 class="modal-title" style="font-size: px; font-weight: bold">Điều
							khoản</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<p>1. Người mua đã thanh toán bằng cách phương thức thanh toán
							hợp lệ nhưng không nhận được sản phẩm, sản phẩm bị lỗi hoặc bị hư
							hại, sai sản phẩm, không ưng ý.</p>
						<p>2. Có thể gửi yêu cầu trả hàng/hoàn tiền trong vòng 7 ngày
							kể từ lúc đơn hàng được cập nhật giao hàng thành công.</p>
						<p>3. Tất cả các yêu cầu trả hànghoàn tiền phải được thực hiện
							trên web hoặc liên hệ trực tiếp tới cửa hàng</p>
						<p>4. Phí gửi hàng lại do người mua trả</p>
						<p>5. Mỗi hóa đơn chỉ được đổi trả 1 lần</p>
						<p>6. Chỉ hỗ trợ đổi size, đổi % đường, đổi sản phẩm bằng hoặc
							hơn giá</p>
						<p>7. Người mua đóng gói và gửi trả sản phẩm bao gồm toàn bộ
							phụ kiện đi kèm, hóa đơn, tem phiếu Size (nếu có) và sản phẩm
							phải trong tình trạng nguyên vẹn như khi nhận hàng.</p>
						<p>8. Người mua bắt buộc phải quay video hoặc chụp lại ảnh sản
							phẩm ngay khi nhận được và trong lúc đóng gói hàng trả về để làm
							bằng chứng đối chiếu/khiếu nại về sau.</p>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-dismiss="modal">Đóng</button>
					</div>
				</div>
			</div>
		</div>
		<!-- Back to top -->
		<div class="btn-back-to-top" id="myBtn">
			<span class="symbol-btn-back-to-top"> <i
				class="zmdi zmdi-chevron-up"></i>
			</span>
		</div>

		<!-- ✅ CSS cho TOPPING -->
		<style>
.topping-item {
	display: inline-flex;
	align-items: center;
	padding: 10px 15px;
	margin: 5px;
	border: 2px solid #dee2e6;
	border-radius: 8px;
	cursor: pointer;
	transition: all 0.3s;
	background: white;
}

.topping-item:hover {
	border-color: #007bff;
	transform: translateY(-2px);
	box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
}

.topping-item.selected {
	border-color: #007bff;
	background-color: #e7f3ff;
}

.topping-item input[type="checkbox"] {
	margin-right: 10px;
	width: 18px;
	height: 18px;
	cursor: pointer;
}

.topping-name {
	font-weight: 500;
	margin-right: 10px;
}

.topping-price {
	color: #28a745;
	font-weight: 600;
}

#topping-total-row {
	background-color: #f8f9fa;
	font-weight: 600;
}

.branch-card {
	border: 1px solid #ddd;
	border-radius: 10px;
	padding: 10px 15px;
	cursor: pointer;
	transition: all 0.25s ease;
	background-color: #fff;
}

.branch-card:hover {
	background-color: #f8f9fa;
	border-color: #007bff;
}

.branch-card.selected {
	border-color: #007bff;
	background-color: #e9f3ff;
	box-shadow: 0 0 6px rgba(0, 123, 255, 0.3);
}

.branch-name {
	font-weight: 600;
	color: #333;
}

.branch-address {
	font-size: 14px;
	color: #666;
}

.branch-phone {
	font-size: 13px;
	color: #888;
}
</style>



		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

		<script th:inline="javascript">
$(document).ready(function () {
    /* ===========================================================
        ⚙️ UTILITY FUNCTIONS
    =========================================================== */
    function removeAnyNonDigit(value) {
        return value ? value.replace(/\D/g, '') : '0';
    }

    function formatNumber(number) {
        if (isNaN(number)) return "0";
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function onlyAllowNumberInput(e) {
        const key = e.key;
        if (key === '-' || key == 0) {
            e.preventDefault();
        }
    }

    let debounceTimer;
    function updateToServer(row, quantity) {
        if (debounceTimer) clearTimeout(debounceTimer);

        const dataSend = {
            id: row.find(".cartId").val(),
            quantity: quantity
        };

        debounceTimer = setTimeout(async function () {
            await $.ajax({
                type: 'POST',
                url: '/api/updateCart',
                data: JSON.stringify(dataSend),
                contentType: "application/json; charset=utf-8",
                error: function (xhr) {
                    swal("Lỗi", xhr.responseJSON?.message || "Không thể cập nhật giỏ hàng", "error");
                    row.find(".num-product").val(1);
                    updateToServer(row, 1);
                }
            });
        }, 500);
    }

    /* ===========================================================
        🏡 ADDRESS FUNCTIONS (TỈNH - HUYỆN - XÃ)
    =========================================================== */
    function loadProvinceSelect(data) {
        const select = document.getElementById("province");
        if (!select) return;

        select.innerHTML = '';
        const def = new Option("Chọn tỉnh / thành phố", "");
        select.appendChild(def);

        data.results.forEach(item => {
            const opt = new Option(item.province_name, item.province_id);
            select.appendChild(opt);
        });
    }

    function loadDistrictSelect(data) {
        const select = document.getElementById("district");
        if (!select) return;

        select.innerHTML = '';
        const def = new Option("Chọn quận / huyện", "");
        select.appendChild(def);

        data.results.forEach(item => {
            const opt = new Option(item.district_name, item.district_id);
            select.appendChild(opt);
        });
    }

    function loadWardSelect(data) {
        const select = document.getElementById("ward");
        if (!select) return;

        select.innerHTML = '';
        const def = new Option("Chọn phường / xã", "");
        select.appendChild(def);

        data.results.forEach(item => {
            const opt = new Option(item.ward_name, item.ward_id);
            select.appendChild(opt);
        });
    }

    /* ===========================================================
        🧋 TOPPING FUNCTIONS
    =========================================================== */
    function loadToppingsForCart() {
        $.ajax({
            url: '/api/user/toppings',
            type: 'GET',
            success: function (toppings) {
                $('.table-shopping-cart .table-row').each(function () {
                    const id = $(this).find('.detailId').val();
                    displayToppingsForProduct(id, toppings);
                });
            },
            error: function () {
                $('.topping-container').each(function () {
                    $(this).html('<p class="text-danger text-center">Không thể tải danh sách topping</p>');
                });
            }
        });
    }

    function displayToppingsForProduct(id, toppings) {
        const box = $(`#topping-selection-${id}`);
        if (!box.length) return;

        box.empty();
        toppings.forEach(t => {
            const item = `
                <label class="topping-item d-flex justify-content-between align-items-center"
                       data-product-id="${id}" data-topping-price="${t.price}">
                    <div>
                        <input type="checkbox" class="topping-checkbox me-2"
                               data-product-id="${id}" value="${t.id}">
                        <span class="topping-name">${t.name}</span>
                    </div>
                    <span class="topping-price">+${formatNumber(t.price)} VND</span>
                </label>`;
            box.append(item);
        });

        box.find('.topping-checkbox').on('change', function () {
            $(this).closest('.topping-item').toggleClass('selected', this.checked);
            updateTotalWithToppings();
        });
    }

    function updateTotalWithToppings() {
        let productTotal = 0;
        let toppingTotal = 0;

        $('.table-row').each(function () {
            const qty = parseInt($(this).find('.num-product').val(), 10) || 1;
            const subtotal = parseFloat($(this).find('.total-money').text().replace(/[^0-9]/g, '')) || 0;
            productTotal += subtotal;

            $(this).find('.topping-checkbox:checked').each(function () {
                const price = parseFloat($(this).closest('.topping-item').data('topping-price')) || 0;
                toppingTotal += price * qty;
            });
        });

        const voucherDiscount = parseFloat(removeAnyNonDigit($('#voucher-pic').text())) || 0;
        let finalTotal = productTotal + toppingTotal - voucherDiscount;
        if (finalTotal < 0) finalTotal = 0;

        $('#sub-total').text(formatNumber(productTotal) + ' VND');
        if (toppingTotal > 0) {
            if (!$('#topping-total-row').length) {
                const row = `
                    <div class="flex-w flex-t bor12 p-b-13 p-t-13" id="topping-total-row">
                        <div class="size-208"><span class="stext-110 cl2">Topping:</span></div>
                        <div class="size-209"><span class="mtext-110 cl2" id="topping-total">${formatNumber(toppingTotal)} VND</span></div>
                    </div>`;
                $('.flex-w.flex-t.bor12.p-b-13:first').after(row);
            } else {
                $('#topping-total').text(formatNumber(toppingTotal) + ' VND');
            }
        } else {
            $('#topping-total-row').remove();
        }

        $('#all-total').text(formatNumber(finalTotal) + ' VND');
        console.log("💰 SP:", productTotal, "| 🍡 TP:", toppingTotal, "| 🎟️ Voucher:", voucherDiscount, "| 💵 Tổng:", finalTotal);
    }

    function getSelectedToppingsForProduct(id) {
        const list = [];
        $(`.topping-checkbox[data-product-id="${id}"]:checked`).each(function () {
            list.push({
                id: parseInt($(this).val()),
                name: $(this).siblings('.topping-name').text(),
                price: parseFloat($(this).closest('.topping-item').data('topping-price'))
            });
        });
        return list;
    }

    /* ===========================================================
        🏬 BRANCH FUNCTIONS
    =========================================================== */
    let selectedBranch = null;
    async function loadBranches() {
        try {
            const res = await fetch('/api/branch-products/branches', { headers: { 'Accept': 'application/json' } });
            if (!res.ok) throw new Error(res.status);

            const branches = await res.json();
            const list = document.getElementById('branchList');
            list.innerHTML = '';

            if (!branches || branches.length === 0) {
                list.innerHTML = `<div class="col-12 text-center text-muted py-3">Hiện chưa có chi nhánh nào hoạt động.</div>`;
                return;
            }

            branches.forEach(b => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                col.innerHTML = `
                    <div class="branch-card" data-branch-id="${b.id}">
                        <div class="branch-name">${b.branchName}</div>
                        <div class="branch-address">📍 ${b.address}</div>
                        <div class="branch-phone">📞 ${b.phone}</div>
                    </div>`;
                col.querySelector('.branch-card').addEventListener('click', function () {
                    document.querySelectorAll('.branch-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedBranch = b;
                    console.log("✅ Đã chọn chi nhánh:", b.branchName);
                });
                list.appendChild(col);
            });
        } catch (err) {
            console.error("❌ Lỗi tải chi nhánh:", err);
            document.getElementById('branchList').innerHTML =
                `<div class="col-12 text-center text-danger py-3">Không tải được danh sách chi nhánh.</div>`;
        }
    }

    /* ===========================================================
        💰 PRICE & VOUCHER CALCULATIONS
    =========================================================== */
    function updateSubtotal(row) {
        var quantity = parseInt(row.find(".num-product").val());
        var price = parseFloat(removeAnyNonDigit(row.find('.product-price').text()));
        var subtotal = quantity * price;
        row.find('.total-money').text(formatNumber(subtotal) + ' VND');
    }

    function calculateVoucherPrice() {
        var voucherList = /*[[${discountCodes}]]*/ '';
        var voucherChoosed = window.voucherChoosed;
        
        if(voucherChoosed) {
            if(voucherChoosed.percentage) {
                var voucherPriceLast;
                var totalMoney = removeAnyNonDigit($('#sub-total').text());
                var value = parseFloat(totalMoney) * voucherChoosed.percentage / 100;
                if(value > voucherChoosed.maximumAmount) {
                    voucherPriceLast = voucherChoosed.maximumAmount;
                } else {
                    voucherPriceLast = Math.round(value);
                }
                $("#voucher-pic").text(formatNumber(voucherPriceLast));
            } else {
                if(voucherChoosed.discountAmount) {
                    $("#voucher-pic").text(formatNumber(voucherChoosed.discountAmount));
                }
            }
        } else {
            $("#voucher-pic").text('0');
        }
    }

    function calculateTotal() {
        var total = 0;
        $('.table-row').each(function () {
            var subtotal = parseFloat($(this).find('.total-money').text().replace(/[^0-9]/g, ''));
            total += subtotal;
        });
        $('#sub-total').text(formatNumber(total) + ' VND');
        $('#all-total').text(formatNumber(total - parseFloat(removeAnyNonDigit($("#voucher-pic").text()))) + ' VND');
        calculateVoucherPrice();
    }

    /* ===========================================================
        🛒 GLOBAL VARIABLES & DATA
    =========================================================== */
    var voucherList = /*[[${discountCodes}]]*/ '';
    window.voucherChoosed = null;

    var addressSelected = {
        street: '',
        ward: '',
        district: '',
        province: '',
    };

    var province = [];
    var district = [];
    var ward = [];

    /* ===========================================================
        📦 EVENT HANDLERS - CART ITEMS
    =========================================================== */
    $('.how-itemcart1').on('click', function () {
        var cartId = $(this).parent().parent().find('.cartId').val();
        Swal.fire({
            title: 'Xóa sản phẩm',
            text: 'Bạn chắc chắc muốn xóa sản phẩm này khỏi giỏ hàng?',
            icon: 'warning',
            showCancelButton: true,
            cancelButtonText: 'Hủy',
            confirmButtonText: 'Xác nhận',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: 'POST',
                    url: `http://localhost:8080/api/deleteCart/${cartId}`,
                    success: function (data) {}
                });

                $(this).parent().parent().remove();
                calculateTotal();

                var currentQua = parseInt(localStorage.getItem("cartQuantity"));
                $(".js-show-cart").attr("data-notify", currentQua - 1);
            }
        });
    });

    /* ===========================================================
        📍 EVENT HANDLERS - ADDRESS
    =========================================================== */
    $(".shipping-choose").on('click', function () {
        $(".shipping-choose").removeClass('active');
        $(this).addClass('active');
    });

    $("#add-address").on('click', function () {
        $("#address-select-group").show();
        $("#add-address").hide();
    });

    $("#save-address-btn").on('click', function () {
        const district = $("#district").val();
        const ward = $("#ward").val();
        const street = $("#street").val().trim();
        if (district == "" || ward == "" || street == "") {
            swal("Lỗi", "Vui lòng nhập đầy đủ địa chỉ");
        } else {
            addressSelected.street = street;
            var dataSend = {
                address: Object.entries(addressSelected)
                    .filter(([key, value]) => value !== null && value !== '')
                    .map(([key, value]) => value)
                    .join(', ')
            };
            $.ajax({
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                url: `api/public/addressShipping`,
                data: JSON.stringify(dataSend),
                success: function (data) {
                    const content = `
                        <div class="shipping-choose">
                            <div id="shipping${data.id}">
                                <p>${data.address}</p>
                            </div>
                        </div>`;

                    $('.address-list').append(content);
                    $(".shipping-choose").on('click', function () {
                        $(".shipping-choose").removeClass('active');
                        $(this).addClass('active');
                    });
                },
                error: function (xhr, status, error) {
                    $('#loading-overlay').hide();
                    swal("Lỗi", xhr.responseJSON.message, "error");
                }
            });
            $("#add-address").show();
            $("#address-select-group").hide();
        }
    });

    $("#cancel-add-address").on('click', function () {
        $("#add-address").show();
        $("#address-select-group").hide();
    });

    $("#province").on('change', function () {
        var provinceId = $(this).val();
        if(provinceId == "") {
            $("#district").html('');
        } else {
            const selectedOption = province.find((option) => option.value === provinceId);
            addressSelected.province = selectedOption.label;
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: `https://vapi.vnappmob.com/api/province/district/01`,
                success: function (data) {
                    district = data.results.map(item => ({ value: item.district_id, label: item.district_name }));
                    loadDistrictSelect(data);
                }
            });
        }
    });

    $.ajax({
        type: 'GET',
        dataType: "json",
        url: `https://vapi.vnappmob.com/api/province/district/01`,
        success: function (data) {
            district = data.results.map(item => ({ value: item.district_id, label: item.district_name }));
            loadDistrictSelect(data);
        }
    });

    $("#district").on('change', function () {
        var districtId = $(this).val();

        if(districtId == "") {
            $("#ward").html('');
        } else {
            const selectedOption = district.find((option) => option.value === districtId);
            addressSelected.district = selectedOption.label;
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: `https://vapi.vnappmob.com/api/province/ward/${districtId}`,
                success: function (data) {
                    ward = data.results.map(item => ({ value: item.ward_id, label: item.ward_name }));
                    loadWardSelect(data);
                }
            });
        }
    });

    $("#ward").on('change', function () {
        const selectedOption = ward.find((option) => option.value === $(this).val());
        addressSelected.ward = selectedOption.label;
    });

    /* ===========================================================
        🛍️ EVENT HANDLERS - QUANTITY CHANGES
    =========================================================== */
    $(".num-product").on('change', function () {
        if($(this).val() > 20) {
            Swal.fire({
                text: 'Bạn chỉ mua được tối đa 20 sản phẩm',
                icon: 'error'
            });
            $(this).val(20);
        }

        $('#selected-voucher').html('');
        $('#selected-voucher').attr('data-selected', "");
        window.voucherChoosed = null;
        calculateVoucherPrice();

        var row = $(this).closest('.table-row');
        updateSubtotal(row);
        updateTotalWithToppings();
        updateToServer(row, $(this).val());

        $('#selected-voucher').html('');
        $('#selected-voucher').attr('data-selected', "");
    });

    $('.num-product').on('keypress', function (e) {
        onlyAllowNumberInput(e);
    });

    $('.num-product').on('focusout', function (e) {
        if($(this).val() == '') {
            $(this).val(1);
            $(this).trigger('change');
        }
    });

    $('.btn-num-product-down').on('click', function(){
        var row = $(this).closest('.table-row');
        $('#selected-voucher').html('');
        $('#selected-voucher').attr('data-selected', "");
        window.voucherChoosed = null;
        calculateVoucherPrice();

        updateSubtotal(row);
        updateTotalWithToppings();
        updateToServer(row, row.find(".num-product").val());
    });

    $('.btn-num-product-up').on('click', function(){
        var row = $(this).closest('.table-row');
        if(row.find(".num-product").val() > 20) {
            Swal.fire({
                text: 'Bạn chỉ mua được tối đa 20 sản phẩm',
                icon: 'error'
            });
            row.find(".num-product").val(20);
            return;
        }
        $('#selected-voucher').html('');
        $('#selected-voucher').attr('data-selected', "");
        window.voucherChoosed = null;
        calculateVoucherPrice();

        updateSubtotal(row);
        updateTotalWithToppings();
        updateToServer(row, row.find(".num-product").val());
    });

    /* ===========================================================
        🎟️ EVENT HANDLERS - VOUCHER
    =========================================================== */
    $(".voucher-item").on('click', function () {
        var voucherId = $(this).attr('data-voucher-id');
        window.voucherChoosed = voucherList.find(item => item.id == voucherId);
        var amountDis = $(this).find('.amount-dis').text();
        var amountMin = $(this).find('.amount-mini').text();
        var amountMax = $(this).find('.amount-max').text();
        if (parseFloat(window.voucherChoosed.minimumAmountInCart) > parseFloat(removeAnyNonDigit($('#sub-total').text()))) {
            swal("Voucher", "Giá trị đơn hàng không đủ để áp dụng voucher này", "error");
            return;
        }
        var html = `<div class="d-flex align-items-center border border-primary rounded" style="width: 300px">
                        <div class="col-sm-3 d-flex justify-content-center align-items-center mr-2" style="background-color: rgb(219 234 254); height: 80px">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12.79 21L3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"></path><path fill="currentColor" d="M11.38 17.41c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.63.58A2.04 2.04 0 0 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM7.25 3a1.25 1.25 0 1 1 0 2.5a1.25 1.25 0 0 1 0-2.5z"></path></svg>
                        </div>
                        <div>
                            <h5 class="font-weight-bold">${amountDis}</h5>
                            <p>${amountMin}</p>
                            <span>${amountMax}</span>
                        </div>
                        <span id="remove-voucher" class="cursor-pointer ml-5">&times;</span>
                    </div>`;

        $('#selected-voucher').html(html);
        $('#selected-voucher').attr('data-selected', voucherId);
        $("#remove-voucher").on('click', function () {
            $('#selected-voucher').attr('data-selected', "");
            $('#selected-voucher').html('');
            window.voucherChoosed = null;
            calculateVoucherPrice();
            calculateTotal();
        });

        $('#exampleModalCenter').modal('hide');

        calculateVoucherPrice();
        calculateTotal();
    });

    /* ===========================================================
        ✅ CHECKBOX & SUBMIT BUTTON
    =========================================================== */
    var checkbox = $('#term');
    var submitBtn = $('#submitBtn');

    checkbox.change(function () {
        submitBtn.prop('disabled', !checkbox.prop('checked'));
    });

    /* ===========================================================
        🚀 SUBMIT ORDER HANDLER
    =========================================================== */
    $("#submitBtn").on('click', async function () {
        try {
            const voucherId = $("#selected-voucher").attr('data-selected') || "";
            const promotion = removeAnyNonDigit($('#voucher-pic').text()) || "0";
            const paymentMethodId = $('input[name="paymentMethod"]:checked').val();
            const selectedAddressElement = $('.shipping-choose.active p');

            // ✅ Kiểm tra chi nhánh
            if (!selectedBranch) {
                swal("Thông báo", "Vui lòng chọn chi nhánh trước khi đặt hàng", "error");
                return;
            }

            // ✅ Kiểm tra địa chỉ
            if (!selectedAddressElement.length || !selectedAddressElement.text().trim()) {
                swal("Thông báo", "Vui lòng chọn hoặc thêm địa chỉ giao hàng trước khi đặt hàng", "error");
                return;
            }

            // ✅ Chuẩn bị danh sách sản phẩm trong giỏ
            const orderDetails = [];
            $('.table-shopping-cart .table-row').each(function () {
                const productDetailId = $(this).find('.detailId').val();
                const quantity = parseInt($(this).find('.num-product').val(), 10);

                // ✅ Bỏ qua sản phẩm lỗi
                if (!productDetailId || isNaN(quantity) || quantity <= 0) return;

                orderDetails.push({
                    productDetailId: productDetailId,
                    quantity: quantity,
                    toppings: getSelectedToppingsForProduct(productDetailId)
                });
            });

            // ✅ Kiểm tra giỏ hàng rỗng
            if (orderDetails.length === 0) {
                swal("Lỗi", "Giỏ hàng trống", "error");
                return;
            }

            // ✅ Tổng tiền hiện tại
            const totalAmount = parseFloat(removeAnyNonDigit($('#all-total').text()) || "0");

            // ✅ Dữ liệu gửi về backend
            const dataSend = {
                branchId: selectedBranch.id,
                paymentMethodId: paymentMethodId,
                billingAddress: selectedAddressElement.text().trim(),
                promotionPrice: promotion,
                voucherId: voucherId,
                orderDetailDtos: orderDetails,
                totalAmount: totalAmount
            };

            console.log("🧾 DỮ LIỆU GỬI LÊN BACKEND:", dataSend);

            // ==================== XỬ LÝ THANH TOÁN ====================

            if (paymentMethodId == 3) {
                // ✅ CHUYỂN KHOẢN: Lưu đơn hàng tạm thời và redirect sang thanh toán
                const amount = removeAnyNonDigit($('#all-total').text());
                console.log("💰 Tổng tiền hiển thị (frontend):", $('#all-total').text());
                console.log("💳 Số tiền gửi sang VNPay:", amount);

                // ✅ Bước 1: Gửi dataSend lên server để lưu vào session
                $.ajax({
                    type: 'POST',
                    url: '/api/save-order-temp',
                    data: JSON.stringify(dataSend),
                    contentType: "application/json; charset=utf-8",
                    async: false,
                    success: function (data) {
                        console.log("✅ Lưu đơn hàng tạm thời thành công");
                    },
                    error: function () {
                        swal("Lỗi", "Không thể lưu đơn hàng tạm thời", "error");
                        return false;
                    }
                });

                // ✅ Bước 2: Gọi API thanh toán VNPay
                await $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    url: `/api/payment?amount=${amount}`,
                    success: function (data) {
                        window.location.href = data.url;
                    },
                    error: function () {
                        swal("Lỗi", "Xảy ra lỗi trong quá trình thanh toán", "error");
                    }
                });

            } else {
                // ✅ TIỀN MẶT: Gọi API tạo đơn hàng trực tiếp
                $('#loading-overlay').show();
                console.log("🧾 DỮ LIỆU GỬI LÊN BACKEND:", JSON.stringify(dataSend, null, 2));

                await $.ajax({
                    type: 'POST',
                    url: '/api/orderUser',
                    data: JSON.stringify(dataSend),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        $('#loading-overlay').hide();
                        console.log("✅ Phản hồi từ backend:", data);

                        Swal.fire({
                            title: 'Đặt hàng',
                            text: 'Đặt hàng thành công',
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonText: 'Tiếp tục mua sắm',
                            cancelButtonText: 'Hủy'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/getproduct';
                            } else {
                                window.location.reload();
                            }
                        });
                    },
                    error: function (xhr, status, error) {
                        $('#loading-overlay').hide();
                        console.error("❌ Lỗi từ backend:", xhr.responseText);
                        swal("Lỗi", xhr.responseJSON.message, "error");
                    }
                });
            }

        } catch (err) {
            console.error("🔥 Lỗi trong quá trình submit:", err);
            swal("Lỗi", "Đã xảy ra lỗi khi gửi đơn hàng!", "error");
        }
    });

    /* ===========================================================
        🎯 INITIALIZATION ON PAGE LOAD
    =========================================================== */
    // Load topping khi trang load
    loadToppingsForCart();

    // Calculate the initial total and update subtotals
    $('.table-row').each(function () {
        updateSubtotal($(this));
    });
    calculateTotal();

    // Load branches
    loadBranches();

    // Tính tổng lần đầu
    $('.table-row').each(function () {
        const qty = parseInt($(this).find('.num-product').val()) || 1;
        const price = parseFloat(removeAnyNonDigit($(this).find('.product-price').text())) || 0;
        const subtotal = qty * price;
        $(this).find('.total-money').text(formatNumber(subtotal) + ' VND');
    });
    updateTotalWithToppings();
});
		</script>
</div>
</body>
</html>