<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{vendor/vendor-layout}">
<head>
    <title>Kho h√†ng - Danh s√°ch s·∫£n ph·∫©m</title>
    <style>
        .table-hover tbody tr:hover {
            background-color: #f5f5f5;
            transition: 0.2s;
        }
        #searchInput, #categorySelect {
            max-width: 280px;
        }
        .badge {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body>
<div layout:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary mb-0">
            <i class="fas fa-boxes"></i> Kho h√†ng - [[${branch.branchName}]]
        </h4>

        <div class="d-flex gap-2">
            <select id="categorySelect" class="form-control mr-2">
                <option value="">-- T·∫•t c·∫£ danh m·ª•c --</option>
            </select>
            <input id="searchInput" type="text" class="form-control" placeholder="üîç T√¨m s·∫£n ph·∫©m...">
        </div>
    </div>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-bordered table-hover align-middle" id="productTable">
            <thead class="thead-dark text-center">
                <tr>
                    <th>M√£</th>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>Size</th>
                    <th>ƒê∆∞·ªùng</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
            </thead>
            <tbody class="text-center">
                <tr>
                    <td colspan="6" class="text-muted py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script th:inline="javascript">
document.addEventListener("DOMContentLoaded", () => {
    const branchId = /*[[${branch.id}]]*/ 0;
    console.log("‚úÖ branchId =", branchId);

    const tbody = document.querySelector("#productTable tbody");
    const searchInput = document.getElementById("searchInput");
    const categorySelect = document.getElementById("categorySelect");

    if (!branchId || branchId === 0) {
        tbody.innerHTML = `
            <tr><td colspan="6" class="text-danger py-3">
                Kh√¥ng t√¨m th·∫•y chi nh√°nh h·ª£p l·ªá (branchId = 0).
            </td></tr>`;
        return;
    }

    // ‚öôÔ∏è Load s·∫£n ph·∫©m c·ªßa chi nh√°nh
    function loadProducts(url = `/api/branch-products/branch/${branchId}`) {
        console.log("üì° Fetching:", url);
        fetch(url)
            .then(res => res.json())
            .then(data => {
                console.log("üì¶ D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);
                const products = data.products || data || [];
                if (products.length === 0) {
                    tbody.innerHTML = `
                        <tr><td colspan="6" class="text-muted py-4">
                            Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong kho.
                        </td></tr>`;
                    return;
                }

                tbody.innerHTML = "";
                products.forEach(p => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${p.productCode || "‚Äî"}</td>
                            <td>
                                <a href="/vendor-page/product-detail?productDetailId=${p.productDetailId}" 
                                   class="text-primary font-weight-bold">
                                    ${p.productName}
                                </a>
                            </td>
                            <td>${p.size?.name || "‚Äî"}</td>
                            <td>${p.color?.name || "‚Äî"}</td>
                            <td>${p.quantity}</td>
                            <td>
                                ${p.quantity > 0
                                    ? '<span class="badge badge-success">C√≤n h√†ng</span>'
                                    : '<span class="badge badge-secondary">H·∫øt h√†ng</span>'}
                            </td>
                        </tr>`;
                });
            })
            .catch(err => {
                console.error("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-danger py-3">
                        L·ªói khi t·∫£i d·ªØ li·ªáu: ${err.message}
                    </td></tr>`;
            });
    }

    // üóÇÔ∏è Load danh m·ª•c gi·∫£ l·∫≠p
    function loadCategories() {
        const demoCats = [
            { id: 1, name: 'Tr√† s·ªØa' },
            { id: 2, name: 'H·ªìng tr√†' },
            { id: 3, name: 'Tr√† tr√°i c√¢y' }
        ];
        demoCats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            categorySelect.appendChild(opt);
        });
    }

    // üîç L·ªçc theo keyword
    searchInput.addEventListener("input", function () {
        const keyword = this.value.toLowerCase();
        const rows = tbody.querySelectorAll("tr");
        rows.forEach(row => {
            const name = row.children[1]?.textContent.toLowerCase();
            const code = row.children[0]?.textContent.toLowerCase();
            row.style.display = (name?.includes(keyword) || code?.includes(keyword)) ? "" : "none";
        });
    });

    // üìÇ L·ªçc theo danh m·ª•c
    categorySelect.addEventListener("change", function () {
        const catId = this.value;
        const url = catId
            ? `/api/branch-products/branch/${branchId}/category/${catId}`
            : `/api/branch-products/branch/${branchId}`;
        loadProducts(url);
    });

    // üöÄ Khi trang load xong
    loadCategories();
    loadProducts();
});
</script>

</body>
</html>
