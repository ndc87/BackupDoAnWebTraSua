<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>üí¨ Chat h·ªó tr·ª£ kh√°ch h√†ng</title>
<link rel="stylesheet"
	th:href="@{/vendor/bootstrap/css/bootstrap.min.css}">
<script th:src="@{/js/sockjs.min.js}"></script>
<script th:src="@{/js/stomp.min.js}"></script>
<style>
body {
	background: #f5f6fa;
	font-family: 'Poppins', sans-serif;
}

.chat-container {
	display: flex;
	height: 90vh;
	margin: 20px;
	border-radius: 10px;
	overflow: hidden;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
	background: white;
}

.chat-users {
	width: 25%;
	border-right: 1px solid #ccc;
	overflow-y: auto;
}

.chat-users h5 {
	padding: 15px;
	background: #007bff;
	color: white;
	margin: 0;
}

.chat-users li {
	padding: 10px 15px;
	cursor: pointer;
	border-bottom: 1px solid #eee;
}

.chat-users li.active {
	background: #e9ecef;
}

.chat-box {
	flex: 1;
	display: flex;
	flex-direction: column;
}

.chat-messages {
	flex: 1;
	padding: 15px;
	overflow-y: auto;
}

.chat-message {
	margin-bottom: 10px;
}

.chat-message.admin {
	text-align: right;
}

.bubble {
	display: inline-block;
	padding: 8px 12px;
	border-radius: 10px;
	max-width: 70%;
}

.chat-message.user .bubble {
	background: #e9ecef;
}

.chat-message.admin .bubble {
	background: #007bff;
	color: white;
}
</style>
</head>
<body>
	<div class="chat-container">
		<div class="chat-users">
			<h5>üë• Ng∆∞·ªùi d√πng</h5>
			<ul id="userList"></ul>
		</div>
		<div class="chat-box">
			<div id="chatMessages" class="chat-messages">
				<div th:each="m : ${messages}"
					th:classappend="${m.sender} == 'admin@gmail.com' ? 'chat-message admin' : 'chat-message user'">
					<div class="bubble" th:text="${m.sender + ': ' + m.content}"></div>
				</div>
			</div>
			<div class="chat-input">
				<input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..."
					style="flex: 1; border: none; padding: 10px;">
				<button id="sendBtn"
					style="background: #007bff; color: white; border: none; padding: 0 15px;">G·ª≠i
					‚û§</button>
			</div>
		</div>
	</div>

	<script>
let stompClient = null;
let selectedUser = null;
let users = new Set();
let messageHistory = new Map(); // ‚úÖ L∆∞u tin nh·∫Øn c·ªßa t·ª´ng user

function connectAdmin() {
  if (typeof SockJS === "undefined") {
    alert("‚ùå SockJS ch∆∞a t·∫£i xong. H√£y reload (Ctrl + Shift + R).");
    return;
  }

  const socket = new SockJS("/ws");
  stompClient = Stomp.over(socket);

  stompClient.connect({}, (frame) => {
    console.log("‚úÖ Admin connected:", frame);

    stompClient.subscribe("/topic/public", (msg) => {
      const data = JSON.parse(msg.body);
      if (data.from && data.from !== "admin") {
        users.add(data.from);
        updateUserList();
      }
      showMessage(data.from, data.content);
    });

    stompClient.subscribe("/user/queue/messages", (msg) => {
      const data = JSON.parse(msg.body);
      if (data.from && !users.has(data.from)) {
        users.add(data.from);
        updateUserList();
      }
      showMessage(data.from, data.content);
    });
  });
}

function updateUserList() {
  const ul = document.getElementById("userList");
  ul.innerHTML = "";
  users.forEach(u => {
    const li = document.createElement("li");
    li.textContent = u;
    li.onclick = () => selectUser(u);
    if (u === selectedUser) li.classList.add("active");
    ul.appendChild(li);
  });
}

function selectUser(user) {
  selectedUser = user;
  updateUserList();
  renderMessageHistory(user); // ‚úÖ Hi·ªÉn th·ªã l·∫°i tin c≈©
}

function renderMessageHistory(user) {
  const msgBox = document.getElementById("chatMessages");
  msgBox.innerHTML = "";
  const messages = messageHistory.get(user) || [];
  messages.forEach(m => {
    const div = document.createElement("div");
    div.classList.add("chat-message", m.from === "admin" ? "admin" : "user");
    div.innerHTML = `<div class="bubble">${m.from}: ${m.content}</div>`;
    msgBox.appendChild(div);
  });
  msgBox.scrollTop = msgBox.scrollHeight;
}

function showMessage(from, content) {
  // ‚úÖ L∆∞u tin nh·∫Øn theo ng∆∞·ªùi
  const target = (from === "admin") ? selectedUser : from;
  if (!messageHistory.has(target)) messageHistory.set(target, []);
  messageHistory.get(target).push({ from, content });

  // N·∫øu ƒëang xem ƒë√∫ng ng∆∞·ªùi, hi·ªÉn th·ªã lu√¥n
  if (target === selectedUser) {
    const msgBox = document.getElementById("chatMessages");
    const div = document.createElement("div");
    div.classList.add("chat-message", from === "admin" ? "admin" : "user");
    div.innerHTML = `<div class="bubble">${from}: ${content}</div>`;
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight;
  }
}

document.getElementById("sendBtn").addEventListener("click", () => {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (text === "" || !selectedUser) return;

  stompClient.send("/app/chat.send", {}, JSON.stringify({
    from: "admin",
    to: selectedUser,
    content: text
  }));

  showMessage("admin", text);
  input.value = "";
});

connectAdmin();
</script>

</body>
</html>
