<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{vendor/vendor-layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Thống kê doanh thu chi nhánh của tôi</title>
</head>

<body>
<div class="main-wrapper" layout:fragment="content">

    <h4>Thống kê doanh thu - <span th:text="${branchName}"></span></h4>

    <!-- 4 ô tổng doanh thu -->
    <div class="row mt-4">
        <div class="col-xl-3 col-sm-6 col-12">
            <div class="card board1 fill">
                <div class="card-body">
                    <div class="dash-widget-header">
                        <div>
                            <h3 id="revenueAll" class="card_widget_header"
                                th:text="${#numbers.formatDecimal(revenueAll, 0, 'POINT', 0, 'COMMA')}"></h3>
                            <h6 class="text-muted">Tổng doanh thu</h6>
                        </div>
                        <div class="ml-auto mt-md-3 mt-lg-0">
                            <span class="opacity-7 text-muted">
                                <i class="fa fa-dollar-sign" style="color:#009688;"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-sm-6 col-12">
            <div class="card board1 fill">
                <div class="card-body">
                    <div class="dash-widget-header">
                        <div>
                            <h3 id="revenueToday" class="card_widget_header"
                                th:text="${#numbers.formatDecimal(revenueToday, 0, 'POINT', 0, 'COMMA')}"></h3>
                            <h6 class="text-muted">Doanh thu hôm nay</h6>
                        </div>
                        <div class="ml-auto mt-md-3 mt-lg-0">
                            <span class="opacity-7 text-muted">
                                <i class="fa fa-chart-line" style="color:#00b894;"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-sm-6 col-12">
            <div class="card board1 fill">
                <div class="card-body">
                    <div class="dash-widget-header">
                        <div>
                            <h3 id="revenueWeek" class="card_widget_header"
                                th:text="${#numbers.formatDecimal(revenueWeek, 0, 'POINT', 0, 'COMMA')}"></h3>
                            <h6 class="text-muted">Doanh thu tuần này</h6>
                        </div>
                        <div class="ml-auto mt-md-3 mt-lg-0">
                            <span class="opacity-7 text-muted">
                                <i class="fa fa-calendar-week" style="color:#6c5ce7;"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-sm-6 col-12">
            <div class="card board1 fill">
                <div class="card-body">
                    <div class="dash-widget-header">
                        <div>
                            <h3 id="revenueMonth" class="card_widget_header"
                                th:text="${#numbers.formatDecimal(revenueMonth, 0, 'POINT', 0, 'COMMA')}"></h3>
                            <h6 class="text-muted">Doanh thu tháng này</h6>
                        </div>
                        <div class="ml-auto mt-md-3 mt-lg-0">
                            <span class="opacity-7 text-muted">
                                <i class="fa fa-calendar-alt" style="color:#0984e3;"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Biểu đồ doanh thu -->
    <div class="row">
        <div class="revenue-month col-md-6">
            <h5>Doanh thu theo từng ngày trong tháng</h5>
            <canvas id="revenueDayInMonth"></canvas>
        </div>
        <div class="revenue-year col-md-6">
            <h5>Doanh thu theo từng tháng trong năm</h5>
            <canvas id="revenueMonthInYear"></canvas>
        </div>
    </div>

    <!-- Theo khoảng thời gian -->
    <div class="row">
        <div class="mt-4 col-md-12">
            <h5>Theo khoảng thời gian</h5>
            <div class="d-flex align-items-center mt-3">
                <div class="mr-2">
                    <label class="form-label">Loại thời gian</label>
                    <select class="form-select" id="time-category">
                        <option value="1">Theo khoảng ngày</option>
                        <option value="2">Theo tháng</option>
                    </select>
                </div>

                <div class="by-date mr-2">
                    <label class="form-label">Ngày bắt đầu</label>
                    <input type="date" id="dateStart" class="form-control">
                </div>

                <div class="by-date mr-2">
                    <label class="form-label">Ngày kết thúc</label>
                    <input type="date" id="dateEnd" class="form-control">
                </div>

                <div class="by-month mr-2">
                    <label class="form-label">Tháng bắt đầu</label>
                    <input type="month" id="monthStart" class="form-control">
                </div>

                <div class="by-month mr-2">
                    <label class="form-label">Tháng kết thúc</label>
                    <input type="month" id="monthEnd" class="form-control">
                </div>

                <div class="mt-4">
                    <button id="apply-statistic" class="btn btn-primary">Áp dụng</button>
                </div>
            </div>

            <div style="width: 100%; height: 400px">
                <canvas id="revenueInTime"></canvas>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script th:inline="javascript">
        const branchId = /*[[${branchId}]]*/ 0;

        document.addEventListener("DOMContentLoaded", function () {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();

            // ✅ Load mặc định khi mở trang
            callApiGetInMonth(currentMonth, currentYear, branchId);
            callApiGetInYear(currentYear, branchId);
            callApiStatisInTime(getDateStart(), getDateEnd(), branchId);
            callApiStatisticInMonth(getMonthStart(), getMonthEnd(), branchId);
        });

        // ================== Các hàm API ==================

        function callApiGetInMonth(month, year, branchId) {
            const url = `/api/get-statistic-revenue-day-in-month?month=${month}&year=${year}&branchId=${branchId}`;
            $.get(url, data => {
                const labels = data.map(d => d.date);
                const values = data.map(d => d.revenue);
                loadChartLine("revenueDayInMonth", labels, values, `Doanh thu tháng ${month}-${year}`);
            });
        }

        function callApiGetInYear(year, branchId) {
            const url = `/api/get-statistic-revenue-month-in-year?year=${year}&branchId=${branchId}`;
            $.get(url, data => {
                const labels = data.map(d => d.month);
                const values = data.map(d => d.revenue);
                loadChartLine("revenueMonthInYear", labels, values, `Doanh thu năm ${year}`);
            });
        }

        function callApiStatisInTime(fromDate, toDate, branchId) {
            const url = `/api/get-statistic-revenue-day-from-time?fromDate=${fromDate}&toDate=${toDate}&branchId=${branchId}`;
            $.get(url, data => {
                const labels = data.map(d => d.date);
                const values = data.map(d => d.revenue);
                loadChartBar("revenueInTime", labels, values, "Doanh thu theo khoảng ngày");
            });
        }

        function callApiStatisticInMonth(fromMonth, toMonth, branchId) {
            const url = `/api/get-statistic-revenue-month-from-time?fromMonth=${fromMonth}&toMonth=${toMonth}&branchId=${branchId}`;
            $.get(url, data => {
                const labels = data.map(d => d.month);
                const values = data.map(d => d.revenue);
                loadChartBar("revenueInTime", labels, values, "Doanh thu theo khoảng tháng");
            });
        }

        // ================== Hàm vẽ biểu đồ ==================
        function loadChartLine(canvasId, labels, data, title) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const existing = Chart.getChart(ctx);
            if (existing) existing.destroy();

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu',
                        data: data,
                        borderColor: '#0984e3',
                        tension: 0.2
                    }]
                },
                options: {
                    plugins: {
                        title: { display: true, text: title },
                        legend: { display: false }
                    }
                }
            });
        }

        function loadChartBar(canvasId, labels, data, title) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const existing = Chart.getChart(ctx);
            if (existing) existing.destroy();

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu',
                        data: data,
                        backgroundColor: '#74b9ff'
                    }]
                },
                options: {
                    plugins: {
                        title: { display: true, text: title },
                        legend: { display: false }
                    }
                }
            });
        }

        // ================== Helper ==================
        function getDateStart() {
            const d = new Date();
            d.setDate(d.getDate() - 30);
            return d.toISOString().split('T')[0];
        }
        function getDateEnd() {
            const d = new Date();
            return d.toISOString().split('T')[0];
        }
        function getMonthStart() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }
        function getMonthEnd() {
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }
    </script>
</div>
</body>
</html>
