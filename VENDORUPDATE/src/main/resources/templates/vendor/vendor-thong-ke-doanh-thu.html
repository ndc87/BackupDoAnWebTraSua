<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{vendor/vendor-layout.html}">

<head>
    <meta charset="UTF-8">
    <title>Thống kê doanh thu chi nhánh của tôi</title>
</head>

<body>
<div layout:fragment="content" class="main-wrapper">

    <h4 class="mb-4">Thống kê doanh thu - <span th:text="${branchName}"></span></h4>

    <!-- ✅ 4 ô tổng doanh thu -->
    <div class="row g-3">
        <div class="col-xl-3 col-sm-6">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h3 th:text="${#numbers.formatDecimal(revenueAll, 0, 'POINT', 0, 'COMMA')}"></h3>
                        <h6 class="text-muted">Tổng doanh thu</h6>
                    </div>
                    <i class="fa fa-dollar-sign fa-2x" style="color:#009688;"></i>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-sm-6">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h3 th:text="${#numbers.formatDecimal(revenueToday, 0, 'POINT', 0, 'COMMA')}"></h3>
                        <h6 class="text-muted">Doanh thu hôm nay</h6>
                    </div>
                    <i class="fa fa-chart-line fa-2x" style="color:#00b894;"></i>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-sm-6">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h3 th:text="${#numbers.formatDecimal(revenueWeek, 0, 'POINT', 0, 'COMMA')}"></h3>
                        <h6 class="text-muted">Doanh thu tuần này</h6>
                    </div>
                    <i class="fa fa-calendar-week fa-2x" style="color:#6c5ce7;"></i>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-sm-6">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h3 th:text="${#numbers.formatDecimal(revenueMonth, 0, 'POINT', 0, 'COMMA')}"></h3>
                        <h6 class="text-muted">Doanh thu tháng này</h6>
                    </div>
                    <i class="fa fa-calendar-alt fa-2x" style="color:#0984e3;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ Biểu đồ doanh thu -->
    <div class="row mt-4">
        <div class="col-md-6">
            <h5>Doanh thu theo từng ngày trong tháng</h5>
            <canvas id="revenueDayInMonth"></canvas>
        </div>
        <div class="col-md-6">
            <h5>Doanh thu theo từng tháng trong năm</h5>
            <canvas id="revenueMonthInYear"></canvas>
        </div>
    </div>

    <!-- ✅ Thống kê theo khoảng thời gian -->
    <div class="row mt-5">
        <div class="col-md-12">
            <h5>Theo khoảng thời gian</h5>
            <div class="d-flex flex-wrap align-items-end gap-3 mt-3">
                <div>
                    <label class="form-label">Loại thời gian</label>
                    <select class="form-select" id="time-category">
                        <option value="1">Theo khoảng ngày</option>
                        <option value="2">Theo tháng</option>
                    </select>
                </div>

                <div class="by-date">
                    <label class="form-label">Ngày bắt đầu</label>
                    <input type="date" id="dateStart" class="form-control">
                </div>

                <div class="by-date">
                    <label class="form-label">Ngày kết thúc</label>
                    <input type="date" id="dateEnd" class="form-control">
                </div>

                <div class="by-month d-none">
                    <label class="form-label">Tháng bắt đầu</label>
                    <input type="month" id="monthStart" class="form-control">
                </div>

                <div class="by-month d-none">
                    <label class="form-label">Tháng kết thúc</label>
                    <input type="month" id="monthEnd" class="form-control">
                </div>

                <div>
                    <button id="apply-statistic" class="btn btn-primary mt-2">Áp dụng</button>
                </div>
            </div>

            <div class="mt-4" style="width: 100%; height: 400px;">
                <canvas id="revenueInTime"></canvas>
            </div>
        </div>
    </div>

    <!-- ✅ Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script th:inline="javascript">
        const branchId = /*[[${branchId}]]*/ 0;

        document.addEventListener("DOMContentLoaded", function () {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();

            callApiGetInMonth(currentMonth, currentYear, branchId);
            callApiGetInYear(currentYear, branchId);
            callApiStatisInTime(getDateStart(), getDateEnd(), branchId);
            callApiStatisticInMonth(getMonthStart(), getMonthEnd(), branchId);
        });

        // ================== Các hàm API ==================
        function callApiGetInMonth(month, year, branchId) {
            $.get(`/api/get-statistic-revenue-day-in-month?month=${month}&year=${year}&branchId=${branchId}`, data => {
                loadChartLine("revenueDayInMonth",
                    data.map(d => d.date),
                    data.map(d => d.revenue),
                    `Doanh thu tháng ${month}-${year}`);
            });
        }

        function callApiGetInYear(year, branchId) {
            $.get(`/api/get-statistic-revenue-month-in-year?year=${year}&branchId=${branchId}`, data => {
                loadChartLine("revenueMonthInYear",
                    data.map(d => d.month),
                    data.map(d => d.revenue),
                    `Doanh thu năm ${year}`);
            });
        }

        function callApiStatisInTime(fromDate, toDate, branchId) {
            $.get(`/api/get-statistic-revenue-day-from-time?fromDate=${fromDate}&toDate=${toDate}&branchId=${branchId}`, data => {
                loadChartBar("revenueInTime",
                    data.map(d => d.date),
                    data.map(d => d.revenue),
                    "Doanh thu theo khoảng ngày");
            });
        }

        function callApiStatisticInMonth(fromMonth, toMonth, branchId) {
            $.get(`/api/get-statistic-revenue-month-from-time?fromMonth=${fromMonth}&toMonth=${toMonth}&branchId=${branchId}`, data => {
                loadChartBar("revenueInTime",
                    data.map(d => d.month),
                    data.map(d => d.revenue),
                    "Doanh thu theo khoảng tháng");
            });
        }

        // ================== Hàm vẽ biểu đồ ==================
        function loadChartLine(canvasId, labels, data, title) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            const old = Chart.getChart(ctx); if (old) old.destroy();

            new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ data, borderColor: '#0984e3', tension: 0.2 }] },
                options: { plugins: { title: { display: true, text: title }, legend: { display: false } } }
            });
        }

        function loadChartBar(canvasId, labels, data, title) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            const old = Chart.getChart(ctx); if (old) old.destroy();

            new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data, backgroundColor: '#74b9ff' }] },
                options: { plugins: { title: { display: true, text: title }, legend: { display: false } } }
            });
        }

        // ================== Helper ==================
        const getDateStart = () => {
            const d = new Date(); d.setDate(d.getDate() - 30);
            return d.toISOString().split('T')[0];
        };
        const getDateEnd = () => new Date().toISOString().split('T')[0];
        const getMonthStart = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        };
        const getMonthEnd = () => {
            const d = new Date(); d.setMonth(d.getMonth() + 1);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        };
    </script>
</div>
</body>
</html>
