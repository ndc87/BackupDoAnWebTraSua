<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω h√≥a ƒë∆°n</title>
</head>
<body>
<div layout:fragment="content">
    <input type="hidden" id="pageValue" th:value="${param.page}"/>
    <input type="hidden" id="sortValue" th:value="${param.sort}"/>
    <input type="hidden" id="ngayTaoStartValue" th:value="${param.ngayTaoStart}"/>
    <input type="hidden" id="ngayTaoEndValue" th:value="${param.ngayTaoEnd}"/>

    <h4>Qu·∫£n l√Ω h√≥a ƒë∆°n</h4>

    <form th:action="@{/admin/bill-list}" method="GET" id="form-search">
        <div class="my-3">
            <div class="form-row">
                <div class="form-group col-md-2">
                    <label for="maDinhDanh">M√£ h√≥a ƒë∆°n</label>
                    <input type="text" class="form-control" id="maDinhDanh" name="maDinhDanh"
                           placeholder="M√£ h√≥a ƒë∆°n" th:value="${maHoaDon}">
                </div>
                <div class="form-group col-md-2">
                    <label for="ngayTaoStart">B·∫Øt ƒë·∫ßu</label>
                    <input type="date" class="form-control" id="ngayTaoStart" name="ngayTaoStart"
                           th:value="${ngayTaoStart}">
                </div>
                <div class="form-group col-md-2">
                    <label for="ngayTaoEnd">K·∫øt th√∫c</label>
                    <input type="date" class="form-control" id="ngayTaoEnd" name="ngayTaoEnd"
                           th:value="${ngayTaoEnd}">
                </div>
                <div class="form-group col-md-2">
                    <label for="trangThai">Tr·∫°ng th√°i</label>
                    <select class="form-select" id="trangThai" name="trangThai">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="CHO_XAC_NHAN" th:selected="${trangThai == 'CHO_XAC_NHAN'}">Ch·ªù x√°c nh·∫≠n</option>
                        <option value="CHO_LAY_HANG" th:selected="${trangThai == 'CHO_LAY_HANG'}">Ch·ªù l·∫•y h√†ng</option>
                        <option value="CHO_GIAO_HANG" th:selected="${trangThai == 'CHO_GIAO_HANG'}">Ch·ªù giao h√†ng</option>
                        <option value="HOAN_THANH" th:selected="${trangThai == 'HOAN_THANH'}">Ho√†n th√†nh</option>
                        <option value="HUY" th:selected="${trangThai == 'HUY'}">H·ªßy</option>
                        <option value="TRA_HANG" th:selected="${trangThai == 'TRA_HANG'}">Tr·∫£ h√†ng</option>
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label for="loaiDon">Lo·∫°i ƒë∆°n</label>
                    <select class="form-select" id="loaiDon" name="loaiDon">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="OFFLINE" th:selected="${loaiDon == 'OFFLINE'}">T·∫°i qu·∫ßy</option>
                        <option value="ONLINE" th:selected="${loaiDon == 'ONLINE'}">Tr·ª±c tuy·∫øn</option>
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label for="hoVaTen">H·ªç v√† t√™n</label>
                    <input type="text" class="form-control" id="hoVaTen" name="hoVaTen"
                           th:value="${hoVaTen}" placeholder="H·ªç v√† t√™n">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-2">
                    <label for="soDienThoai">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" class="form-control" id="soDienThoai" name="soDienThoai"
                           th:value="${soDienThoai}" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                </div>
            </div>

            <button type="submit" class="btn btn-primary m-1"><i class="fa fa-search"></i> T√¨m ki·∫øm</button>
            <a th:href="@{/admin/bill-list}" class="btn btn-secondary m-1">H·ªßy b·ªè</a>
            <button type="button" class="btn btn-success m-1" onclick="exportToExcel()">
                <i class="far fa-file-excel"></i> Export
            </button>
        </div>
    </form>

    <div class="alert alert-success" role="alert" th:if="${message}">
        <span th:text="${message}"></span>
    </div>

    <table class="table table-hover border my-3" style="cursor: pointer; font-size: 13px" id="billTable">
        <thead class="thead-light">
        <tr>
            <th scope="col">M√£ h√≥a ƒë∆°n</th>
            <th scope="col">M√£ ƒë·ªïi tr·∫£</th>
            <th scope="col">H·ªç v√† t√™n</th>
            <th scope="col">S·ªë ƒëi·ªán tho·∫°i</th>
            <th scope="col">Ng√†y ƒë·∫∑t</th>
            <th scope="col">T·ªïng ti·ªÅn</th>
            <th scope="col">Lo·∫°i ƒë∆°n</th>
            <th scope="col">H√¨nh th·ª©c TT</th>
            <th scope="col">Tr·∫°ng th√°i</th>
            <th scope="col">Thao t√°c</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="item : ${items}" class="clickable-row" th:data-maHoaDon="${item.maHoaDon}">
            <th scope="row" th:text="${item.maDinhDanh}">HD09347</th>
            <th>
                <a class="text-primary"
                   th:href="@{'/admin-only/bill-return-detail-code/' + ${item.maDoiTra}}"
                   th:text="${item.maDoiTra}"></a>
            </th>
            <td th:text="${item.hoVaTen}">Mark</td>
            <td th:text="${item.soDienThoai}">03843234</td>
            <td th:text="${#temporals.format(item.ngayTao, 'dd-MM-yyyy HH:mm')}">01-01-2024</td>
            <td th:text="${#numbers.formatDecimal(item.tongTien, 0, 'POINT', 0, 'COMMA')}">0</td>

            <!-- ‚úÖ S·ª≠a an to√†n ph·∫ßn Enum -->
            <td>
                <span th:if="${item.loaiDon?.name() == 'OFFLINE' or item.loaiDon == 'OFFLINE'}">T·∫°i qu·∫ßy</span>
                <span th:if="${item.loaiDon?.name() == 'ONLINE' or item.loaiDon == 'ONLINE'}">Online</span>
            </td>

            <td>
                <span th:if="${item.hinhThucThanhToan == 'THE'}">Th·∫ª</span>
                <span th:if="${item.hinhThucThanhToan == 'CHUYEN_KHOAN'}">Chuy·ªÉn kho·∫£n</span>
                <span th:if="${item.hinhThucThanhToan == 'TIEN_MAT'}">Ti·ªÅn m·∫∑t</span>
            </td>

            <td>
                <!-- ‚úÖ S·ª≠a an to√†n ph·∫ßn tr·∫°ng th√°i -->
                <span class="text-warning p-1 rounded border border-warning font-weight-bold"
                      th:if="${item.trangThai?.name() == 'CHO_XAC_NHAN' or item.trangThai == 'CHO_XAC_NHAN'}">
                    <i class="fas fa-check-square"></i>&nbsp;Ch·ªù x√°c nh·∫≠n
                </span>
                <span class="text-secondary p-1 rounded border border-secondary font-weight-bold"
                      th:if="${item.trangThai?.name() == 'CHO_LAY_HANG' or item.trangThai == 'CHO_LAY_HANG'}">
                    <i class="fas fa-check-square"></i>&nbsp;Ch·ªù l·∫•y h√†ng
                </span>
                <span class="text-primary p-1 rounded border border-primary font-weight-bold"
                      th:if="${item.trangThai?.name() == 'CHO_GIAO_HANG' or item.trangThai == 'CHO_GIAO_HANG'}">
                    <i class="fas fa-check-square"></i>&nbsp;Ch·ªù giao h√†ng
                </span>
                <span class="text-success p-1 rounded border border-success font-weight-bold"
                      th:if="${item.trangThai?.name() == 'HOAN_THANH' or item.trangThai == 'HOAN_THANH'}">
                    <i class="fas fa-check-square"></i>&nbsp;Ho√†n th√†nh
                </span>
                <span class="text-dark p-1 rounded border border-dark font-weight-bold"
                      th:if="${item.trangThai?.name() == 'TRA_HANG' or item.trangThai == 'TRA_HANG'}">
                    <i class="fas fa-check-square"></i>&nbsp;ƒê·ªïi tr·∫£
                </span>
                <span class="text-danger p-1 rounded border border-danger font-weight-bold"
                      th:if="${item.trangThai?.name() == 'HUY' or item.trangThai == 'HUY'}">
                    <i class="fa fa-times-circle"></i>&nbsp;H·ªßy
                </span>
            </td>

            <td>
                <div class="d-flex align-items-center">
                    <form th:action="@{'/admin/update-bill-status/' + ${item.maHoaDon}}" method="get">
                        <input type="hidden" name="trangThaiDonHang" value="HUY">
                        <span type="button"
                              th:if="${item.trangThai?.name() == 'CHO_XAC_NHAN' or item.trangThai?.name() == 'CHO_LAY_HANG' 
                              or item.trangThai == 'CHO_XAC_NHAN' or item.trangThai == 'CHO_LAY_HANG'}"
                              class="cancel-btn bg-transparent mr-2" title="H·ªßy ƒë∆°n">‚ùå</span>
                    </form>

                    <form th:action="@{'/admin/update-bill-status/' + ${item.maHoaDon}}" method="get">
                        <span type="button"
                              th:if="${!(item.trangThai?.name() == 'HOAN_THANH' or item.trangThai?.name() == 'HUY' or item.trangThai?.name() == 'TRA_HANG'
                              or item.trangThai == 'HOAN_THANH' or item.trangThai == 'HUY' or item.trangThai == 'TRA_HANG')}"
                              class="hover-green btn-update-status" th:data-status="${item.trangThai}" title="Chuy·ªÉn tr·∫°ng th√°i">üîÅ</span>
                    </form>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <script th:inline="javascript">
        $(document).ready(function () {
            $('.cancel-btn').on('click', function (e) {
                e.stopPropagation();
                Swal.fire({
                    title: "X√°c nh·∫≠n?",
                    text: "B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n n√†y!",
                    icon: "warning",
                    showCancelButton: true,
                    cancelButtonText: 'H·ªßy',
                    confirmButtonText: 'X√°c nh·∫≠n',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $(this).closest('form').submit();
                    }
                });
            });

            $('.btn-update-status').on('click', function (e) {
                e.stopPropagation();
                var currentStatus = $(this).attr('data-status');
                var nextStatus, msg;
                switch (currentStatus) {
                    case "CHO_XAC_NHAN": nextStatus = "CHO_LAY_HANG"; msg = "Ch·ªù l·∫•y h√†ng"; break;
                    case "CHO_LAY_HANG": nextStatus = "CHO_GIAO_HANG"; msg = "Ch·ªù giao h√†ng"; break;
                    case "CHO_GIAO_HANG": nextStatus = "HOAN_THANH"; msg = "Ho√†n th√†nh"; break;
                }
                Swal.fire({
                    title: "X√°c nh·∫≠n?",
                    text: `X√°c nh·∫≠n chuy·ªÉn sang ${msg}?`,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "X√°c nh·∫≠n",
                    cancelButtonText: "H·ªßy"
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = $(this).closest('form').attr('action') + `?trangThaiDonHang=${nextStatus}`;
                    }
                });
            });
        });

        document.querySelectorAll(".clickable-row").forEach(row => {
            let last = 0;
            row.addEventListener("click", () => {
                let now = Date.now();
                if (now - last < 300) {
                    window.location.href = "/admin/getbill-detail/" + row.getAttribute("data-maHoaDon");
                }
                last = now;
            });
        });

        function exportToExcel() {
            Swal.fire({
                title: "X√°c nh·∫≠n?",
                text: "X√°c nh·∫≠n export file excel?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "X√°c nh·∫≠n",
                cancelButtonText: "H·ªßy"
            }).then(result => {
                if (result.isConfirmed) {
                    const p = $("#pageValue").val(), s = $("#sortValue").val();
                    const start = $("#ngayTaoStart").val(), end = $("#ngayTaoEnd").val();
                    window.location.href = `/admin/export-bill?page=${p}&sort=${s}&ngayTaoStart=${start}&ngayTaoEnd=${end}`;
                }
            });
        }
    </script>
</div>
</body>
</html>
