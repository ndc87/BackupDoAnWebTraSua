<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªçn Chi Nh√°nh v√† ƒê·∫∑t H√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .branch-selector {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .branch-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        .branch-option:hover {
            border-color: #007bff;
            background-color: #f0f7ff;
        }
        .branch-option.selected {
            border-color: #007bff;
            background-color: #e7f3ff;
            font-weight: bold;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .product-info {
            padding: 15px;
        }
        .product-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .product-price {
            color: #d32f2f;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .product-stock {
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .stock-low {
            color: #ff6f00;
        }
        .stock-out {
            color: #d32f2f;
        }
        .cart-sidebar {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .cart-sidebar.active {
            right: 0;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-10">
                <h2>üõçÔ∏è Ch·ªçn Chi Nh√°nh v√† Mua H√†ng</h2>
            </div>
            <div class="col-md-2 text-end">
                <button class="btn btn-outline-primary" id="cartBtn">
                    üõí Gi·ªè h√†ng (<span id="cartCount">0</span>)
                </button>
            </div>
        </div>

        <!-- Ch·ªçn Chi Nh√°nh -->
        <div class="branch-selector">
            <h4 class="mb-3">üìç Ch·ªçn Chi Nh√°nh</h4>
            <div id="branchList" class="row">
                <div class="col-12 text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- S·∫£n ph·∫©m -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üì¶ S·∫£n Ph·∫©m C·ªßa Chi Nh√°nh</h5>
            </div>
            <div class="card-body">
                <div id="productsLoading" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <p>ƒêang t·∫£i s·∫£n ph·∫©m...</p>
                </div>
                <div id="productGrid" class="product-grid"></div>
            </div>
        </div>
    </div>

    <!-- Gi·ªè h√†ng Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <button class="btn-close" id="closeCartBtn" style="float: right;"></button>
        <h5>Gi·ªè H√†ng</h5>
        <div id="cartItems"></div>
        <hr>
        <div class="mb-3">
            <label for="billingAddress" class="form-label">ƒê·ªãa Ch·ªâ Giao H√†ng</label>
            <textarea class="form-control" id="billingAddress" rows="3" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng"></textarea>
        </div>
        <div class="mb-3">
            <strong>T·ªïng Ti·ªÅn:</strong> <span id="totalPrice">0</span> ƒë
        </div>
        <button class="btn btn-success w-100" id="checkoutBtn">ƒê·∫∑t H√†ng</button>
    </div>

    <!-- Modal th√¥ng b√°o -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messageTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="messageBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedBranch = null;
        let cart = [];
        const customerId = new URLSearchParams(window.location.search).get('customerId') || 1;

        // L·∫•y danh s√°ch chi nh√°nh
        async function loadBranches() {
            try {
                const response = await fetch('/api/branch-products/branches');
                const branches = await response.json();

                const branchList = document.getElementById('branchList');
                branchList.innerHTML = '';

                branches.forEach(branch => {
                    const div = document.createElement('div');
                    div.className = 'col-md-6 mb-3';
                    div.innerHTML = `
                        <div class="branch-option" onclick="selectBranch(${branch.id}, '${branch.name}')">
                            <strong>${branch.code} - ${branch.name}</strong><br>
                            üìû ${branch.phone}<br>
                            üìç ${branch.address}
                        </div>
                    `;
                    branchList.appendChild(div);
                });
            } catch (error) {
                console.error('L·ªói t·∫£i chi nh√°nh:', error);
                showMessage('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch chi nh√°nh');
            }
        }

        // Ch·ªçn chi nh√°nh
        async function selectBranch(branchId, branchName) {
            selectedBranch = { id: branchId, name: branchName };
            
            // C·∫≠p nh·∫≠t UI
            document.querySelectorAll('.branch-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.branch-option').classList.add('selected');

            // T·∫£i s·∫£n ph·∫©m c·ªßa chi nh√°nh
            loadProducts(branchId);
        }

        // L·∫•y danh s√°ch s·∫£n ph·∫©m c·ªßa chi nh√°nh
        async function loadProducts(branchId) {
            try {
                document.getElementById('productsLoading').style.display = 'block';
                document.getElementById('productGrid').innerHTML = '';

                const response = await fetch(`/api/branch-products/branch/${branchId}`);
                const data = await response.json();

                document.getElementById('productsLoading').style.display = 'none';

                if (!data.products || data.products.length === 0) {
                    document.getElementById('productGrid').innerHTML = 
                        '<div class="col-12"><p class="text-center text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</p></div>';
                    return;
                }

                const productGrid = document.getElementById('productGrid');
                data.products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    
                    let stockClass = '';
                    if (product.quantity === 0) {
                        stockClass = 'stock-out';
                    } else if (product.quantity < 5) {
                        stockClass = 'stock-low';
                    }

                    card.innerHTML = `
                        <div class="product-info">
                            <div class="product-name">${product.productName}</div>
                            <div class="product-price">${product.price.toLocaleString()} ƒë</div>
                            <div class="product-stock ${stockClass}">
                                Kho: ${product.quantity}
                            </div>
                            <div style="font-size: 12px; color: #999;">
                                M√†u: ${product.color || 'N/A'} | Size: ${product.size || 'N/A'}
                            </div>
                            <div class="mt-3">
                                <input type="number" class="form-control form-control-sm mb-2" 
                                       value="1" min="1" max="${product.quantity}" 
                                       data-product-id="${product.productDetailId}"
                                       data-product-name="${product.productName}"
                                       data-product-price="${product.price}"
                                       placeholder="S·ªë l∆∞·ª£ng">
                                <button class="btn btn-primary btn-sm w-100" 
                                        onclick="addToCart(${product.productDetailId}, '${product.productName}', ${product.price}, this)">
                                    Th√™m v√†o gi·ªè
                                </button>
                            </div>
                        </div>
                    `;
                    productGrid.appendChild(card);
                });
            } catch (error) {
                console.error('L·ªói t·∫£i s·∫£n ph·∫©m:', error);
                showMessage('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m');
            }
        }

        // Th√™m v√†o gi·ªè h√†ng
        function addToCart(productDetailId, productName, price, button) {
            if (!selectedBranch) {
                showMessage('C·∫£nh b√°o', 'Vui l√≤ng ch·ªçn chi nh√°nh tr∆∞·ªõc');
                return;
            }

            const input = button.parentElement.querySelector('input[type="number"]');
            const quantity = parseInt(input.value);

            if (quantity <= 0) {
                showMessage('C·∫£nh b√°o', 'Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá');
                return;
            }

            // Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè kh√¥ng
            const existingItem = cart.find(item => item.productDetailId === productDetailId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    productDetailId,
                    productName,
                    price,
                    quantity
                });
            }

            updateCartUI();
            showMessage('Th√†nh c√¥ng', `ƒê√£ th√™m ${productName} v√†o gi·ªè h√†ng`);
        }

        // C·∫≠p nh·∫≠t UI gi·ªè h√†ng
        function updateCartUI() {
            document.getElementById('cartCount').textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';

            let total = 0;
            cart.forEach((item, index) => {
                const amount = item.price * item.quantity;
                total += amount;

                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div>
                        <strong>${item.productName}</strong><br>
                        ${item.price.toLocaleString()} x ${item.quantity} = ${amount.toLocaleString()}ƒë
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">X</button>
                `;
                cartItems.appendChild(div);
            });

            document.getElementById('totalPrice').textContent = total.toLocaleString();
        }

        // X√≥a kh·ªèi gi·ªè h√†ng
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
        }

        // ƒê·∫∑t h√†ng
        async function checkout() {
            if (cart.length === 0) {
                showMessage('C·∫£nh b√°o', 'Gi·ªè h√†ng tr·ªëng');
                return;
            }

            if (!selectedBranch) {
                showMessage('C·∫£nh b√°o', 'Vui l√≤ng ch·ªçn chi nh√°nh');
                return;
            }

            const billingAddress = document.getElementById('billingAddress').value;
            if (!billingAddress) {
                showMessage('C·∫£nh b√°o', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng');
                return;
            }

            const orderData = {
                branchId: selectedBranch.id,
                customerId: parseInt(customerId),
                billingAddress: billingAddress,
                items: cart.map(item => ({
                    productDetailId: item.productDetailId,
                    quantity: item.quantity
                }))
            };

            try {
                const response = await fetch('/api/orders/create-with-branch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Th√†nh c√¥ng', `ƒê·∫∑t h√†ng th√†nh c√¥ng!\nM√£ ƒë∆°n: ${result.billCode}\nT·ªïng: ${result.totalAmount.toLocaleString()}ƒë`);
                    cart = [];
                    updateCartUI();
                    document.getElementById('billingAddress').value = '';
                    document.getElementById('cartSidebar').classList.remove('active');
                } else {
                    showMessage('L·ªói', result.error);
                }
            } catch (error) {
                console.error('L·ªói ƒë·∫∑t h√†ng:', error);
                showMessage('L·ªói', 'Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(title, message) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageBody').textContent = message;
            new bootstrap.Modal(document.getElementById('messageModal')).show();
        }

        // Event listeners
        document.getElementById('cartBtn').addEventListener('click', function() {
            document.getElementById('cartSidebar').classList.add('active');
        });

        document.getElementById('closeCartBtn').addEventListener('click', function() {
            document.getElementById('cartSidebar').classList.remove('active');
        });

        document.getElementById('checkoutBtn').addEventListener('click', checkout);

        // T·∫£i chi nh√°nh khi trang load
        window.addEventListener('load', loadBranches);
    </script>
</body>
</html>
